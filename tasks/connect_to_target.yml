---
- name: Discover WWNs from iSCSI server
  command: >-
    iscsiadm --mode discoverydb --type sendtargets --discover
    --portal {{ iscsi_target_ip }}:{{ iscsi_target_port }}
  args:
    creates: "{{ send_targets_path }}{{ iscsi_target_ip }},{{ iscsi_target_port }}/st_config"

- name: Find which targets are provided by iSCSI server
  find:
    paths: [ "{{ send_targets_path }}{{ iscsi_target_ip }},{{ iscsi_target_port }}" ]
    file_type: 'link'
  register: find_result

  # FIXME: figure out how to run login only when we are not yet logged in
- name: Login into iSCSI server
  command: >-
    iscsiadm --mode node --targetname {{ (item.path|basename).split(',')[0] }} --login
    --portal {{ (item.path|basename).split(',')[1] }}:{{ (item.path|basename).split(',')[2] }}
  with_items:
    - "{{ find_result['files'] }}"

- name: Change to automatic startup on *SUSE
  command: >-
    iscsiadm --mode node --targetname {{ (item.path|basename).split(',')[0] }}
    --portal {{ (item.path|basename).split(',')[1] }}:{{ (item.path|basename).split(',')[2] }}
    -o update -n node.conn[0].startup -v automatic -n node.startup -v automatic
  with_items:
    - "{{ find_result['files'] }}"
  when: 'ansible_distribution == "SLES" or ansible_distribution == "openSUSE Leap"'
